<section class="bg-[#BFE3F9] min-h-screen w-full">

    <!-- SIDE BAR-->
    <aside class="fixed top-0 left-0 h-screen w-80 bg-gradient-to-b from-[#BFE3F9] via-[#9ACCE6] to-[#6097BA]">
        <h1 class="font-sans text-2xl font-semibold text-black text-center mt-10 border-b-4 border-black pb-2">
            Lists
        </h1>
        
        <?php
        $tasklists = $this->tasklists ?? [];
        $baseUrl = $this->baseUrl();
        include __DIR__ . '/../tasklists/sidebarView.phtml';
        ?>

        <!-- BOTTOM LEFT-->
        <div class="absolute bottom-6 left-6 flex space-x-4">
            <!--  ICON USER  -->
            <a href="<?php echo $this->baseUrl(); ?>/profile"
                class="bg-white hover:bg-gray-100 p-3 rounded-full shadow-lg transition-all duration-200 group"
                title="View Profile">

                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>

            </a>

            <!-- Icon Logout -->
            <a href="<?php echo $this->baseUrl(); ?>/logout"
                class="bg-red-500 hover:bg-red-600 p-3 rounded-full shadow-lg transition-all duration-200 group"
                title="Logout"
                onclick="return confirm('Are you sure you want to logout?')">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"></path>
                </svg>
            </a>
        </div>
    </aside>

     <!-- TASK PAGE -->
    <main class="ml-[22rem] min-h-screen border-4 border-[#BFE3F9] rounded-lg m-6 p-2 bg-white">
        <div class="px-8 py-6">
            <h2 class="text-3xl font-bold mb-6">Tasks</h2>

            <?php if (!empty($_SESSION['error'])): ?>
                <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                    <?php echo htmlspecialchars($_SESSION['error']); unset($_SESSION['error']); ?>
                </div>
            <?php endif; ?>
            <?php if (!empty($_SESSION['success'])): ?>
                <div class="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded">
                    <?php echo htmlspecialchars($_SESSION['success']); unset($_SESSION['success']); ?>
                </div>
            <?php endif; ?>

            <?php
            $noTasklists = $this->noTasklists; 
            $currentListId = $this->currentListId; 
            ?>

                
            <?php if (isset($noTasklists) && $noTasklists === true): ?>
                <!-- NO TASKLIST CREATED-->
                <div class="text-center py-10">
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-6 py-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Let's Get Organized!</h3>
                        <p class="text-lg">You haven't created any task lists yet.</p>
                        <p class="mt-2 text-sm">ðŸ‘ˆ Please create a list using the sidebar to start adding tasks.</p>
                    </div>
                </div>

            <?php elseif (empty($currentListId)): ?>
                <!-- TASKLIST CREATED BUT NOT SELECTED -->
                <div class="text-center py-10">
                    <div class="bg-blue-100 border border-blue-400 text-blue-700 px-6 py-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Select a List</h3>
                        <p class="text-lg">Please select a task list from the sidebar to view and add tasks.</p>
                    </div>
                </div>
            <?php else: ?>

                <!-- TASK LIST SELECTED -->
                <form action="<?php echo $this->baseUrl() ?>/tasks/filterStatus" method="GET" class="mb-4 flex items-center space-x-4">
                    <label for="taskStatus" class="text-blue-500 hover:underline">Filter tasks by status</label>
                    <select name="taskStatus" id="taskStatus" class="border border-gray-300 rounded p-2">
                        <option value="all" <?php echo ($this->currentStatus ?? 'all') === 'all' ? 'selected' : ''; ?>>All</option>
                        <option value="pending" <?php echo ($this->currentStatus ?? 'all') === 'pending' ? 'selected' : ''; ?>>Pending</option>
                        <option value="in_progress" <?php echo ($this->currentStatus ?? 'all') === 'in_progress' ? 'selected' : ''; ?>>In Progress</option>
                        <option value="completed" <?php echo ($this->currentStatus ?? 'all') === 'completed' ? 'selected' : ''; ?>>Completed</option>
                    </select>
                    <input type="submit" value="Filter" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition">
                </form>

                <?php if (is_array($this->tasks) && count($this->tasks) > 0): ?>
                    <div class="space-y-4">
                        <?php foreach ($this->tasks as $task): ?>
                            <div class="flex items-center justify-between border-b border-black pb-2 m-2">
                                <div class="flex-grow">
                                    <p class="text-sm text-gray-500">
                                       Status: <?= htmlspecialchars($task['taskStatus'] ?? 'No status') ?>
                                    </p>
                                    <h4>
                                        Name: <?= htmlspecialchars($task['nameTask'] ?? 'No name') ?>
                                    </h4>
                                    <p> Description:<?=htmlspecialchars($task['description'] ?? 'Sin descripciÃ³n')  ?>
                                </div>
                                <div class="flex space-x-6">
                                   <div class="flex flex-col items-center">
                                        <p class="text-sm font-medium text-black mb-2">
                                            dataStart:
                                        </p>
                                        <div class="w-28 h-20 border-4 border-[#BFE3F9] flex items-center justify-center rounded bg-white">
                                            <p class="text-sm text-center"><?= htmlspecialchars($task['startDate'] ?? '') ?></p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <p class="text-sm font-medium text-black mb-2">
                                            EndDate:
                                        </p>
                                        <div class="w-28 h-20 border-4 border-[#BFE3F9] flex items-center justify-center rounded bg-white">
                                            <p class="text-sm text-center"><?= htmlspecialchars($task['endDate'] ?? '') ?></p>
                                        </div>
                                    </div>
                                    <div class ='flex flex-col space-y-2 justify-center'>
                                    <a href="<?php echo $this->baseUrl() ?>/tasks/delete/<?php echo $task['id'] ?>" class="text-red-500 hover:underline">
                                       Delete
                                    </a>
                                    <a href="<?php echo $this->baseUrl() ?>/tasks/update/<?php echo $task['id'] ?>" class="text-blue-500 hover:underline">
                                        Edit
                                    </a>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; ?>
                        <details id="creaTask" class="flex items-center justify-between border-b border-black pb-2 m-2">
                            <summary class="cursor-pointer text-blue-500 hover:underline">+</summary>
                            <div class="p-6 bg-gray-100 rounded">
                                <iframe id="createTaskFrame"
                                    name="createTaskFrame"
                                    src="<?php echo $this->baseUrl() ?>/tasks/create"
                                    class="w-full h-64"
                                    onload="RefrescarIframe();">
                                </iframe>
                            </div>
                        </details>
                        <button
                            class="mt-4 w-40 h-12 border-4 border-[#BFE3F9] flex items-center justify-center rounded bg-white hover:bg-[#BFE3F9] transition"
                            onclick="Refrescar()">
                            Refresh
                        </button>
                    </div>
                <?php else: ?>
                    <p class="text-center text-gray-500 py-10">There are no tasks in this list.</p>
                    <details id="creaTask" class="flex items-center justify-between border-b border-black pb-2 m-2">
                        <summary class="cursor-pointer text-blue-500 hover:underline">+</summary>
                        <div class="p-6 bg-gray-100 rounded">
                            <iframe id="createTaskFrame"
                                name="createTaskFrame"
                                src="<?php echo $this->baseUrl() ?>/tasks/create"
                                class="w-full h-64"
                                onload="RefrescarIframe();">
                            </iframe>
                        </div>
                    </details>
                <?php endif; ?>
            <?php endif; // Fine del blocco if/elseif/else principale ?>
        </div>
    </main>
</section>
<script>
    function Refrescar() {
        location.reload();
    }

    function RefrescarIframe() {
        let detailsElement = document.getElementById('creaTask');

        if (detailsElement.hasAttribute('open')) {
            detailsElement.removeAttribute('open');
            location.reload();
        }
    }
</script>